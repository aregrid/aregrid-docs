var t=Object.defineProperty,e=Object.defineProperties,o=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,i=(e,o,r)=>o in e?t(e,o,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[o]=r,l=(t,e)=>{for(var o in e||(e={}))s.call(e,o)&&i(t,o,e[o]);if(r)for(var o of r(e))n.call(e,o)&&i(t,o,e[o]);return t};import{l as d,o as a,c as u,a as c,F as h,r as p,b as y}from"./vendor.8c0409e7.js";const f="INSERT_CHARTER",m="DELETE_CHARTER",g=/Mac/i.test(navigator.platform)?"metaKey":"ctrlKey";class k{static match(t,e){return!["altKey","ctrlKey","metaKey","shiftKey"].some((o=>!!e[o]!==t[o]&&null!==e[o]))&&(e.key===t.key||e.key===t.which)}constructor(t){this.editor=t,this.bindings={},Object.keys(k.DEFAULTS.bindings).forEach((t=>{k.DEFAULTS.bindings[t]&&this.addBinding(k.DEFAULTS.bindings[t])})),this.listen()}addBinding(t,r={},s={}){const n=function(t){if("string"==typeof t||"number"==typeof t)t={key:t};else{if("object"!=typeof t)return null;t=d.cloneDeep(t)}t.shortKey&&(t[g]=t.shortKey,delete t.shortKey);return t}(t);if(null==n)return void console.warn("Attempted to add invalid keyboard binding",n);"function"==typeof r&&(r={handler:r}),"function"==typeof s&&(s={handler:s});(Array.isArray(n.key)?n.key:[n.key]).forEach((t=>{const i=l(l((d=l({},n),e(d,o({key:t}))),r),s);var d;this.bindings[i.key]=this.bindings[i.key]||[],this.bindings[i.key].push(i)}))}getBindsByEvt(t){if(1===t.key.length&&(!this.bindings[t.key]||0===this.bindings[t.key].length)){let e=d.cloneDeep(k.DEFAULTS.bindings.insertCharacter);return e.key=t.key,this.addBinding(t.key,e),this.bindings[t.key]||[]}return this.bindings[t.key]||[]}listen(){this.editor.getRoot().focus(),this.editor.getRoot().addEventListener("keydown",(t=>{if(t.defaultPrevented||t.isComposing)return;let e=this.getBindsByEvt(t).concat(this.bindings[t.which]||[]).filter((e=>k.match(t,e)));if(0===e.length)return;const o=this.editor.getSelection(),r={userInput:t.key};e.some((t=>!0!==t.handler.call(this,o,r,t)))&&t.preventDefault()}))}}k.DEFAULTS={bindings:{Undo:{key:"z",shortKey:!0,handler(){this.editor.undo()}},Backspace:{key:"Backspace",handler(t,e){let o={type:m,startIndex:t[0]};return this.editor.flush(o),!1}},Enter:{key:"Enter",metaKey:null,ctrlKey:null,altKey:null,handler(t,e){let o={type:f,startIndex:t[0],value:"\n"};return this.editor.flush(o),!1}},insertCharacter:{handler(t,e){let o={type:f,startIndex:t[0],value:e.userInput};return this.editor.flush(o),!1}},left:{key:"ArrowLeft",handler(){this.editor.getCursorInfo().locationX>0?this.editor.updateCursorInfo(--this.editor.getCursorInfo().locationX):this.editor.getCursorInfo().locationY>0&&this.editor.updateCursorInfo(void 0,--this.editor.getCursorInfo().locationY),this.editor.flush()}},right:{key:"ArrowRight",handler(){this.editor.getCursorInfo().locationX+1<=this.editor.getCurrentBlockCharacterCount()&&(this.editor.updateCursorInfo(++this.editor.getCursorInfo().locationX),this.editor.flush())}},up:{key:"ArrowUp",handler(){this.editor.getCursorInfo().locationY>0&&this.editor.updateCursorInfo(void 0,--this.editor.getCursorInfo().locationY),this.editor.flush()}},down:{key:"ArrowDown",handler(){this.editor.getCursorInfo().locationY<this.editor.blocks.length-1&&(this.editor.updateCursorInfo(void 0,++this.editor.getCursorInfo().locationY),this.editor.flush())}}}};var S,_={insertStr:(t,e,o)=>t.slice(0,e)+o+t.slice(e),removeStr:(t,e)=>t.slice(0,e)+t.slice(e+1)};class b{constructor(){this.spacers_=""}getSpackers(){return this.spacers_}insertStr(t,e){return _.insertStr(this.spacers_,t,e)}removeStr(t){return _.removeStr(this.spacers_,t)}getSpackerAt(t){return this.spacers_.substr(t,1)}updateSpacers(t){this.spacers_=t}}function I(){}I.prototype={undoCommands:[],undo(){return this.undoCommands.pop()},record(t){this.undoCommands.push(t)}};var C={getHtmlSize(t){if(!t)return{width:0};if(t=t.replace(/\s/g,"&nbsp;"),!S){(S=document.createElement("iframe")).style.visibility="hidden";document.body.appendChild(S),function(t,e){t.sandbox="allow-same-origin",t.contentWindow.document.open(),t.contentWindow.document.write(e),t.contentWindow.document.close()}(S,'<body><span id="box"></span></body>')}let e=S.contentWindow.document.getElementById("box");return e.setAttribute("style","font-size:14px;"),e.innerHTML=t,S.contentWindow.document.getElementById("box").getBoundingClientRect()}},v=15,w=15;const E="UNDO",M="USER_EDIT";class x{constructor(){this.history_=new I,this.model_=new b,this.commands_=[],this.cursorInfo_={locationX:0,locationY:0},this.cursorStyle_={},this.blocks_=[]}applyCommand(t,{editSource:e=E}){this.commands_.push(t),this.updateModel(t,{editSource:e})}getCursorSpacerIndex(){let t=0;if(this.cursorInfo_.locationY>0){let e=this.blocks_.slice(0,this.cursorInfo_.locationY),o=0;e.forEach((t=>o+=t.html.length)),t=o+this.cursorInfo_.locationY}return t+this.cursorInfo_.locationX}updateBlocks(){let t=this.model_.getSpackers().split("\n");this.blocks_=t.map((t=>({html:t}))),this.blocksForRedraw_=this.blocks_.map((t=>{let e=t.html.replace(/\s/g,"&nbsp;"),o=C.getHtmlSize(e);return{html:e,overlayStyle:{width:o.width+"px",height:o.height+"px"}}}))}getBlocksForRedraw(){return this.blocksForRedraw_}getSelection(){return[this.getCursorSpacerIndex(),this.getCursorSpacerIndex()]}getCurrentCursorLoctionX(){return this.getCurrentBlock().html.length}updateModel(t,{editSource:e=M}={}){if(t.type===f){let o=t.startIndex;e===M&&this.history_.record({type:m,startIndex:o+1});let r=this.model_.insertStr(o,t.value);this.model_.updateSpacers(r),"\n"===t.value?(this.cursorInfo_.locationY+=1,this.cursorInfo_.locationX=0):this.cursorInfo_.locationX+=1}else if(t.type===m){let o=t.startIndex;if(0===o)return;let r=this.model_.getSpackerAt(o-1);e===M&&this.history_.record({type:f,startIndex:o,value:r}),this.removeSpackerIndex(o-1)}}removeSpackerIndex(t){if("\n"===this.model_.getSpackerAt(t)){let t;this.cursorInfo_.locationY>0&&(t=this.blocks_[this.cursorInfo_.locationY-1].html.length),this.cursorInfo_.locationY-=1,this.cursorInfo_.locationX=t}else this.cursorInfo_.locationX-=1;let e=this.model_.removeStr(t);this.model_.updateSpacers(e)}getCurrentBlock(){return this.blocks_[this.cursorInfo_.locationY]||{html:""}}updateCursor(){this.blocks_.length;let t=this.getCurrentBlock();this.cursorStyle_={left:w+C.getHtmlSize(t.html.substr(0,this.cursorInfo_.locationX)).width+"px",top:v+20*this.cursorInfo_.locationY+"px"}}getCursorStyle(){return this.cursorStyle_}getCursorInfo(){return this.cursorInfo_}updateCursorInfo(t,e){d.isUndefined(t)||(this.cursorInfo_.locationX=t),d.isUndefined(e)||(this.cursorInfo_.locationY=e)}undo(){return this.history_.undo()}getCommands(){return this.commands_}}const B="UNDO",A="USER_EDIT",D={name:"App",data:()=>({toolbarMenus:[{key:"bold"},{key:"italic"},{key:"underline"},{key:"strikethrough"}],cursorStyle:{},blocks:[],editStyle:{paddingTop:v+"px",paddingBottom:v+"px",paddingLeft:w+"px",paddingRight:w+"px"}}),components:{},methods:{undo(){this.flush(this.modeState_.undo(),{editSource:B})},flush(t,{editSource:e=A}={}){t&&this.modeState_.applyCommand(t,{editSource:e}),this.redraw()},redraw(){this.modeState_.updateBlocks(),this.modeState_.updateCursor(),this.blocks=this.modeState_.getBlocksForRedraw(),this.cursorStyle=this.modeState_.getCursorStyle()},onEditorMouseDown(){this.startMouse=!0,this.curorMoveInfo=[0,0,0,0]},onEditorMouseUp(){this.startMouse=!1},onEditorMouseMove(t){this.startMouse&&console.log(t)},getRoot:()=>window,getSelection(){return this.modeState_.getSelection()},getCursorInfo(){return this.modeState_.getCursorInfo()},updateCursorInfo(){this.modeState_.updateCursorInfo.apply(this.modeState_,arguments)},getCurrentBlockCharacterCount(){return this.modeState_.getCurrentBlock().html.length},replay(){let t=e=>{if(0===e.length)return;let o=e[0];setTimeout((()=>{this.flush(o),e.splice(0,1),t(e)}),200)},e=JSON.parse(JSON.stringify(this.modeState_.getCommands()));this.blocks=[],this.modeState_=new x,t(e)}},mounted(){this.keyboard_=new k(this),this.modeState_=new x}},R={class:"zd"},Y={class:"zd-toolbar"},T={class:"zd-block"};D.render=function(t,e,o,r,s,n){return a(),u("div",R,[c("div",Y,[c("button",{onClick:e[1]||(e[1]=(...t)=>n.replay&&n.replay(...t))},"replay command record")]),c("div",{class:"zd-editor",ref:"editor",style:s.editStyle,onMousedown:e[2]||(e[2]=(...t)=>n.onEditorMouseDown&&n.onEditorMouseDown(...t)),onMouseup:e[3]||(e[3]=(...t)=>n.onEditorMouseUp&&n.onEditorMouseUp(...t)),onMousemove:e[4]||(e[4]=(...t)=>n.onEditorMouseMove&&n.onEditorMouseMove(...t))},[c("span",{style:s.cursorStyle,class:"zd-cursor"},null,4),(a(!0),u(h,null,p(s.blocks,(t=>(a(),u("p",T,[c("div",{innerHTML:t.html},null,8,["innerHTML"]),c("div",{class:"overlay",style:t.overlayStyle},null,4)])))),256))],36)])};y(D).mount("#app");
